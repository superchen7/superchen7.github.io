<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis | superchen的博客</title><meta name="author" content="superchen7"><meta name="copyright" content="superchen7"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="[TOC] 概述1.适合放入缓存的数据1.即时性、数据一致性要求不高的例如，物流信息、商品分类（一致性并不需要实时——不需强制一致性、需要最终一致性）、商品列表 适合缓存并加一个失效时间（根据数据更新频率来定） 2.访问量大且更新频率不高的数据（读多，写少）商品信息：后台如果发布一个商品，买家需要5分钟才能看到新的商品一般还是可以接受的 2.读模式缓存使用流程  伪代码：  3.本地缓存与局限性本">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://superchen7.github.io/2023/06/01/Redis/index.html">
<meta property="og:site_name" content="superchen的博客">
<meta property="og:description" content="[TOC] 概述1.适合放入缓存的数据1.即时性、数据一致性要求不高的例如，物流信息、商品分类（一致性并不需要实时——不需强制一致性、需要最终一致性）、商品列表 适合缓存并加一个失效时间（根据数据更新频率来定） 2.访问量大且更新频率不高的数据（读多，写少）商品信息：后台如果发布一个商品，买家需要5分钟才能看到新的商品一般还是可以接受的 2.读模式缓存使用流程  伪代码：  3.本地缓存与局限性本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://superchen7.github.io/img/touxiang.png">
<meta property="article:published_time" content="2023-06-01T13:18:31.000Z">
<meta property="article:modified_time" content="2024-06-24T13:28:53.848Z">
<meta property="article:author" content="superchen7">
<meta property="article:tag" content="java">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://superchen7.github.io/img/touxiang.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://superchen7.github.io/2023/06/01/Redis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-24 21:28:53'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/bizhi.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="superchen的博客"><img class="site-icon" src="/img/touxiang.png"/><span class="site-name">superchen的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-01T13:18:31.000Z" title="发表于 2023-06-01 21:18:31">2023-06-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-24T13:28:53.848Z" title="更新于 2024-06-24 21:28:53">2024-06-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA%E5%BC%80%E5%8F%91/">JAVA开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>[TOC]</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="1-适合放入缓存的数据"><a href="#1-适合放入缓存的数据" class="headerlink" title="1.适合放入缓存的数据"></a>1.适合放入缓存的数据</h2><h3 id="1-即时性、数据一致性要求不高的"><a href="#1-即时性、数据一致性要求不高的" class="headerlink" title="1.即时性、数据一致性要求不高的"></a>1.即时性、数据一致性要求不高的</h3><p>例如，物流信息、商品分类（一致性并不需要实时——不需强制一致性、需要最终一致性）、商品列表</p>
<p>适合缓存并加一个失效时间（根据数据更新频率来定）</p>
<h3 id="2-访问量大且更新频率不高的数据（读多，写少）"><a href="#2-访问量大且更新频率不高的数据（读多，写少）" class="headerlink" title="2.访问量大且更新频率不高的数据（读多，写少）"></a>2.访问量大且更新频率不高的数据（读多，写少）</h3><p>商品信息：后台如果发布一个商品，买家需要5分钟才能看到新的商品一般还是可以接受的</p>
<h2 id="2-读模式缓存使用流程"><a href="#2-读模式缓存使用流程" class="headerlink" title="2.读模式缓存使用流程"></a>2.读模式缓存使用流程</h2><p> <img src="/2023/06/01/Redis/1635512538828.png" alt="1635512538828"></p>
<p>伪代码：</p>
<p><img src="/2023/06/01/Redis/1635512623631.png" alt="1635512623631"></p>
<h2 id="3-本地缓存与局限性"><a href="#3-本地缓存与局限性" class="headerlink" title="3.本地缓存与局限性"></a>3.本地缓存与局限性</h2><p>本地缓存示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ol>
<li>集群情况下，每个节点的本地缓存可能会不一致（数据一致性）</li>
<li>缓存没能及时的同步更新</li>
</ol>
<p><img src="/2023/06/01/Redis/1635513182709-1719234326833-2.png" alt="1635513182709"></p>
<h2 id="4-分布式缓存"><a href="#4-分布式缓存" class="headerlink" title="4.分布式缓存"></a>4.分布式缓存</h2><p>使用缓存中间件：	</p>
<p>redis（集群、分片）</p>
<p><img src="/2023/06/01/Redis/1635513259851.png" alt="1635513259851"></p>
<h1 id="整合redis"><a href="#整合redis" class="headerlink" title="整合redis"></a>整合redis</h1><p><strong>把 redis 看做 Map</strong></p>
<h2 id="1-使用springboot整合redis"><a href="#1-使用springboot整合redis" class="headerlink" title="1.使用springboot整合redis"></a>1.使用springboot整合redis</h2><h3 id="1-在需要使用redis的模块导入依赖，启动器"><a href="#1-在需要使用redis的模块导入依赖，启动器" class="headerlink" title="1.在需要使用redis的模块导入依赖，启动器"></a>1.在需要使用redis的模块导入依赖，启动器</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-RedisAutoConfiguration-查看自动配置"><a href="#2-RedisAutoConfiguration-查看自动配置" class="headerlink" title="2.RedisAutoConfiguration 查看自动配置"></a>2.RedisAutoConfiguration 查看自动配置</h3><p>在.yml增加以下配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="comment"># password: ...</span></span><br></pre></td></tr></table></figure>

<h3 id="3-使用-SpringBoot-自动配置好的-RedisTemplate-或者-StringRedisTemplate-即可操作-redis"><a href="#3-使用-SpringBoot-自动配置好的-RedisTemplate-或者-StringRedisTemplate-即可操作-redis" class="headerlink" title="3.使用 SpringBoot 自动配置好的 RedisTemplate 或者 StringRedisTemplate 即可操作 redis"></a>3.使用 SpringBoot 自动配置好的 RedisTemplate 或者 StringRedisTemplate 即可操作 redis</h3><p>一般使用 StringRedisTemplate，具体使用见下面 2.单元测试用例</p>
<blockquote>
<p>redis 中存储的 value 最好是 JSON 数据，以便实现 value 的通用性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> JSON.toJSONString(catelogJsonFromDb);</span><br><span class="line">stringRedisTemplate.opsForValue().set(<span class="string">&quot;catelog&quot;</span>, value);</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="2-单元测试用例"><a href="#2-单元测试用例" class="headerlink" title="2.单元测试用例"></a>2.单元测试用例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试redis</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedis</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取操作对象</span></span><br><span class="line">    ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储</span></span><br><span class="line">    ops.set(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span> + UUID.randomUUID());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取</span></span><br><span class="line">    System.out.println(ops.get(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <img src="/2023/06/01/Redis/1635514358072.png" alt="1635514358072"></p>
<h2 id="3-lettuce-堆外内存溢出（springboot-2-3-2-已解决）"><a href="#3-lettuce-堆外内存溢出（springboot-2-3-2-已解决）" class="headerlink" title="3.lettuce 堆外内存溢出（springboot 2.3.2 已解决）"></a>3.lettuce 堆外内存溢出（springboot 2.3.2 已解决）</h2><h3 id="3-1-lettuce、jedis、redistemplate"><a href="#3-1-lettuce、jedis、redistemplate" class="headerlink" title="3.1.lettuce、jedis、redistemplate"></a>3.1.lettuce、jedis、redistemplate</h3><p>三者分别是什么？</p>
<ul>
<li>lettuce：redis的客户端，对redis操作进行封装，内部使用 netty 进行网络通信，性能很强</li>
<li>jedis：redis的客户端，对redis操作进行封装，停止更新了</li>
<li>redistemplate：是springboot对redis客户端的再封装</li>
</ul>
<h3 id="3-2-原因"><a href="#3-2-原因" class="headerlink" title="3.2.原因"></a>3.2.原因</h3><h4 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h4><p>当进行压力测试时后期出现堆外内存溢出OutOfDirectMemoryError（压力测试指查询缓存数据）</p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>1）springboot2.0以后默认使用lettuce作为操作redis的客户端，它使用netty进行网络通信，使用netty创建连接时未及时释放连接</p>
<p>2）如果没有为netty指定对外内存，默认使用Xms的值（使用-Dio.netty.maxDirectMemory设置值）</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>升级 springboot 到 2.3.2 版本及其以上，此时配套的 redis 依赖会升级到无 bug 的版本</li>
<li>单独升级 lettuce 客户端</li>
<li>切换使用 jedis（见下面）</li>
<li>只是调大堆外内存治标不治本</li>
</ol>
<h3 id="3-3-解决方法：切换-jedis（注意-springboot-2-3-2-已修复这个问题）"><a href="#3-3-解决方法：切换-jedis（注意-springboot-2-3-2-已修复这个问题）" class="headerlink" title="3.3.解决方法：切换 jedis（注意 springboot 2.3.2 已修复这个问题）"></a>3.3.解决方法：切换 jedis（注意 springboot 2.3.2 已修复这个问题）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">步骤：</span><br><span class="line">排除lettuce依赖，导入jedis</span><br><span class="line"><span class="comment">&lt;!--redis启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--排除springboot默认的redis客户端lettus--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--jedis，操作redis的客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-缓存失效问题"><a href="#4-缓存失效问题" class="headerlink" title="4.缓存失效问题"></a>4.缓存失效问题</h2><p>读模式，会存在缓存失效问题：</p>
<ol>
<li>缓存穿透</li>
<li>雪崩</li>
<li>击穿</li>
</ol>
<h3 id="4-1-缓存穿透（数据不在缓存）"><a href="#4-1-缓存穿透（数据不在缓存）" class="headerlink" title="4.1.缓存穿透（数据不在缓存）"></a>4.1.缓存穿透（数据不在缓存）</h3><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><p>查询一个一定不存在的数据，导致一定会查询缓存+查询 DB，缓存失去意义（大并发过来时仍然会查询db）</p>
<h4 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h4><p>利用不存在的数据进行攻击，数据库顺时压力增大，最终导致崩溃</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>方法 1：将null结果缓存，并加入短暂过期时间</p>
<p>弊端：查询条件使用UUID生成，仍然出现缓存穿透问题，并且redis存满了null</p>
<p>方法2：布隆过滤器，不放行不存在的查询</p>
<p>在redis维护id的hash表过滤掉id不存在的查询（不到达DB层查询）</p>
<h3 id="4-2-缓存雪崩（缓存大面积失效）"><a href="#4-2-缓存雪崩（缓存大面积失效）" class="headerlink" title="4.2.缓存雪崩（缓存大面积失效）"></a>4.2.缓存雪崩（缓存大面积失效）</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">缓存雪崩：</span><br><span class="line">	高并发状态下，大面积redis数据失效，导致所有查询到达DB，DB瞬时压力过重雪崩</span><br><span class="line">	</span><br><span class="line">解决：</span><br><span class="line">	方法<span class="number">1</span>：规避雪崩，设置随机的有效时间（实际上无需设置随机时间，因为每个缓存放入库中的时间本身就不固定）</span><br><span class="line">		让每一个缓存过期时间重复率降低，</span><br><span class="line">	</span><br><span class="line">	方法<span class="number">2</span>：永不失效</span><br><span class="line"></span><br><span class="line">	方法<span class="number">3</span>：</span><br><span class="line">		事前：尽量保证整个 redis 集群的高可用性，发现机器宕机尽快补上。选择合适的内存淘汰策略。</span><br><span class="line">		事中：本地ehcache缓存 + hystrix限流&amp;降级，避免MySQL崩掉</span><br><span class="line">		事后：利用 redis 持久化机制保存的数据尽快恢复缓存 </span><br><span class="line"></span><br><span class="line">问题：如果已经出现了缓存雪崩，如何解决？</span><br><span class="line">	方法<span class="number">1</span>：熔断、降级</span><br></pre></td></tr></table></figure>

<h3 id="4-3-缓存击穿（一条失效）"><a href="#4-3-缓存击穿（一条失效）" class="headerlink" title="4.3.缓存击穿（一条失效）"></a>4.3.缓存击穿（一条失效）</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">缓存击穿：</span><br><span class="line">	高并发状态下，一条数据过期，所有请求到达DB</span><br><span class="line"></span><br><span class="line">解决：</span><br><span class="line">	方法<span class="number">1</span>：加分布式锁</span><br><span class="line">	例原子操作（Redis的SETNX或者Memcache的ADD）</span><br><span class="line">	流程：查询cache失败，竞争锁，竞争成功查询cache，查询成功返回释放锁</span><br><span class="line">		查询失败则查询DB，并set缓存，并释放锁</span><br><span class="line"></span><br><span class="line">	方法<span class="number">2</span>：永不失效</span><br></pre></td></tr></table></figure>

<h3 id="4-4-锁时效问题"><a href="#4-4-锁时效问题" class="headerlink" title="4.4.锁时效问题"></a>4.4.锁时效问题</h3><ol>
<li>将查询结果放入缓存的操作，应该放在同步代码块内，否则会造成重复查询 DB 的情况</li>
<li>双重缓存验证：加锁后也应该再次查看缓存是否已经存在，已存在则不应继续查询</li>
</ol>
<p> <img src="/2023/06/01/Redis/1635663356474.png" alt="1635663356474"></p>
<h3 id="4-5-模拟分布式本地锁失效"><a href="#4-5-模拟分布式本地锁失效" class="headerlink" title="4.5.模拟分布式本地锁失效"></a>4.5.模拟分布式本地锁失效</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>启动多份配置</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>修改压测配置</span><br><span class="line">	gulimall.com	<span class="number">80</span></span><br><span class="line">    /index/catalog.json</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>开始压测</span><br><span class="line">	<span class="number">100</span>个线程  循环<span class="number">5</span>次</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>本地锁失效，多次查询数据库</span><br></pre></td></tr></table></figure>

<p> <img src="/2023/06/01/Redis/1635663592317.png" alt="1635663592317"></p>
<h2 id="5-分布式锁"><a href="#5-分布式锁" class="headerlink" title="5.分布式锁"></a>5.分布式锁</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文档<span class="number">1</span>：http<span class="punctuation">:</span><span class="comment">//redisdoc.com/string/set.html</span></span><br><span class="line">文档<span class="number">2</span>：http<span class="punctuation">:</span><span class="comment">//www.redis.cn/commands/set.html</span></span><br></pre></td></tr></table></figure>



<p> <img src="/2023/06/01/Redis/1635664198425.png" alt="1635664198425"></p>
<h3 id="5-1-演示分布式锁-SET-NX"><a href="#5-1-演示分布式锁-SET-NX" class="headerlink" title="5.1.演示分布式锁 SET NX"></a>5.1.演示分布式锁 SET NX</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1.打开多个sh框</span><br><span class="line"></span><br><span class="line">2.打开xshell撰写栏（查看-&gt;撰写-&gt;撰写栏）</span><br><span class="line"></span><br><span class="line">3.编辑命令，发送给多个窗口，同时连接redis客户端</span><br><span class="line">docker <span class="built_in">exec</span> -it redis redis-cli</span><br><span class="line"></span><br><span class="line">4.编辑命令，发送给多个窗口，同时占锁</span><br><span class="line"><span class="built_in">set</span> key value NX</span><br><span class="line">返回OK表示占锁成功，返回nill占锁失败</span><br><span class="line"></span><br><span class="line">5.设置锁过期时间</span><br><span class="line"><span class="built_in">set</span> key value EX 300 NX</span><br><span class="line"></span><br><span class="line">6.查看锁过期时间</span><br><span class="line">ttl lock</span><br></pre></td></tr></table></figure>

<p>发送命令至全部会话：</p>
<p> <img src="/2023/06/01/Redis/1635669533421.png" alt="1635669533421"></p>
<p>锁值：</p>
<p> <img src="/2023/06/01/Redis/1635670061333.png" alt="1635670061333"></p>
<p>Java 中的 set-NX：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock == true：成功放入，否则，redis 中已存在这个 key，无法放入</span></span><br><span class="line"><span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;111&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>记得删除 key </li>
<li>记得没有正常加锁的重试操作</li>
</ol>
<h3 id="5-2-问题合集"><a href="#5-2-问题合集" class="headerlink" title="5.2.问题合集"></a>5.2.问题合集</h3><h4 id="问题1：删除锁"><a href="#问题1：删除锁" class="headerlink" title="问题1：删除锁"></a>问题1：删除锁</h4><p>未执行删除锁逻辑，会导致其他线程无法获得锁，出现死锁、</p>
<h4 id="问题2：设置过期时间"><a href="#问题2：设置过期时间" class="headerlink" title="问题2：设置过期时间"></a>问题2：设置过期时间</h4><p>锁释放操作可能失败（服务宕机），所以需要设置过期时间</p>
<h4 id="问题3：设置过期时间的原子性"><a href="#问题3：设置过期时间的原子性" class="headerlink" title="问题3：设置过期时间的原子性"></a>问题3：设置过期时间的原子性</h4><p>设置过期时间的代码必须在 set-NX 抢占锁的同时设置，保证原子性</p>
<h4 id="问题4：仅可以删除当前线程占用的锁"><a href="#问题4：仅可以删除当前线程占用的锁" class="headerlink" title="问题4：仅可以删除当前线程占用的锁"></a>问题4：仅可以删除当前线程占用的锁</h4><p>删除锁时，可能锁已过期删除了其他线程的锁。</p>
<p>解决：占锁时设置值为 java.util.UUID，删除时判断当前 uuid 是否相等，并且需要使用 lua 脚本执行原子删除操作</p>
<p> <img src="/2023/06/01/Redis/1635670158689.png" alt="1635670158689"></p>
<p> <img src="/2023/06/01/Redis/1635673350495.png" alt="1635673350495"></p>
<h3 id="5-3-redis分布式锁版本"><a href="#5-3-redis分布式锁版本" class="headerlink" title="5.3.redis分布式锁版本"></a>5.3.redis分布式锁版本</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询三级分类（原生版redis分布式锁版本）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2VO&gt;&gt; <span class="title function_">getCatalogJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.抢占分布式锁，同时设置过期时间</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="comment">// 使用setnx占锁（setIfAbsent）</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(CategoryConstant.LOCK_KEY_CATALOG_JSON, uuid, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">        <span class="comment">// 2.抢占成功</span></span><br><span class="line">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 查询DB</span></span><br><span class="line">            <span class="keyword">return</span> getCatalogJsonFromDB();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3.查询UUID是否是自己，是自己的lock就删除</span></span><br><span class="line">            <span class="comment">// 封装lua脚本（原子操作解锁）</span></span><br><span class="line">            <span class="comment">// 查询+删除（当前值与目标值是否相等，相等执行删除，不等返回0）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">luaScript</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1]\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;then\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    return redis.call(&#x27;del&#x27;,KEYS[1])\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    return 0\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end&quot;</span>;</span><br><span class="line">            <span class="comment">// 删除锁</span></span><br><span class="line">            redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;Long&gt;(luaScript, Long.class), Arrays.asList(CategoryConstant.LOCK_KEY_CATALOG_JSON), uuid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 4.加锁失败，自旋重试</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCatalogJsonFromDBWithRedisLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Redisson"><a href="#Redisson" class="headerlink" title="Redisson"></a>Redisson</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文档：</span><br><span class="line">https<span class="punctuation">:</span><span class="comment">//github.com/redisson/redisson/wiki/Table-of-Content</span></span><br></pre></td></tr></table></figure>

<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><p>1.不推荐直接使用SET-NX实现分布式锁，应该使用 Redisson</p>
<p>因为根据锁的实现会分为</p>
<ul>
<li>读写锁</li>
<li>可重入锁</li>
<li>闭锁</li>
<li>信号量</li>
</ul>
<p>2.封装了分布式Map、List等类型</p>
<p>3.Redisson与lettuce、jedis一样都是redis的客户端，代替了redisTemplate</p>
<h2 id="2-使用-原生的-redisson-看门狗"><a href="#2-使用-原生的-redisson-看门狗" class="headerlink" title="2.使用 原生的 redisson(看门狗)"></a>2.使用 原生的 redisson(看门狗)</h2><p>步骤：</p>
<p>1.引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redisson，redis客户端，封装了分布式锁实现，也可以使用springboot的方式，不需要自己配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.配置类，根据官方文档：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入客户端实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redisson</span><span class="params">(<span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span> String host, <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span>String port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.创建配置</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port);<span class="comment">// 单节点模式</span></span><br><span class="line"><span class="comment">//        config.useSingleServer().setAddress(&quot;rediss://&quot; + host + &quot;:&quot; + port);// 使用安全连接</span></span><br><span class="line"><span class="comment">//        config.useClusterServers().addNodeAddress(&quot;127.0.0.1:7004&quot;, &quot;127.0.0.1:7001&quot;);// 集群模式</span></span><br><span class="line">        <span class="comment">// 2.创建redisson客户端实例</span></span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本处使用单节点 redis 模式</p>
<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(redissonClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-1-可重入锁"><a href="#2-1-可重入锁" class="headerlink" title="2.1.可重入锁"></a>2.1.可重入锁</h3><p>redisson实现了JUC包下的可重入锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;redisson_lock&quot;</span>);	<span class="comment">// 锁的名字一样，那就是同一把锁</span></span><br></pre></td></tr></table></figure>

<p>简单理解可重入锁：假设存在 A()、B()，A 和 B 都将锁同一把锁，且 A() 中尝试调用了 B()，如果是非可重用锁，那么因为 B() 在 A() 执行后永远等不到锁的释放，而死锁；如果是可重入锁，则 B() 继续正常执行，A() 正常释放锁。 </p>
<h3 id="2-2-过期时间、自动续期、手动释放（lua原子操作）"><a href="#2-2-过期时间、自动续期、手动释放（lua原子操作）" class="headerlink" title="2.2.过期时间、自动续期、手动释放（lua原子操作）"></a>2.2.过期时间、自动续期、手动释放（lua原子操作）</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">原理：</span></span><br><span class="line">	<span class="attr">//</span> <span class="string">1）默认过期时间30S</span></span><br><span class="line">    <span class="attr">//</span> <span class="string">2）锁自动续期+30S，业务超长情况下（看门狗）</span></span><br><span class="line">    <span class="attr">//</span> <span class="string">3）如果线程宕机，看门狗不会自动续期，锁会自动过期</span></span><br><span class="line">    <span class="attr">//</span> <span class="string">4）unlock使用lua脚本释放锁，不会出现误删锁</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">代码案例：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试redisson实现分布式锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testRedisson&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.获取锁</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;redisson_lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.加锁</span></span><br><span class="line">    <span class="comment">// 1）业务超长情况下（看门狗），锁自动续期+30S</span></span><br><span class="line">    <span class="comment">// 2）如果线程宕机（死亡），看门狗不会自动续期，锁会自动过期</span></span><br><span class="line">    <span class="comment">// 3）unlock使用lua脚本释放锁，不会出现误删锁</span></span><br><span class="line">    lock.lock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 加锁成功，执行业务</span></span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功，执行业务...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 3.解锁</span></span><br><span class="line">        System.out.println(<span class="string">&quot;解锁...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRedisson&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-指定超时，不自动续期"><a href="#2-3-指定超时，不自动续期" class="headerlink" title="2.3.指定超时，不自动续期"></a>2.3.指定超时，不自动续期</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);	<span class="comment">// 10秒钟自动解锁,自动解锁时间一定要大于业务执行时间</span></span><br></pre></td></tr></table></figure>

<p>1.查看 <code>lock()</code> 和 <code>lock(10, TimeUnit.SECONDS)</code> 源码</p>
<ol>
<li>当不指定超时时间时，默认 30S 过期，且启动一个定时任务【自动续期任务】<br>续期时间点 &#x3D; 默认过期时间&#x2F;3。即，每隔10S执行一次续期</li>
<li>当指定超时时间时，不会自动续期</li>
</ol>
<p>2.推荐<strong>设置过期时间</strong></p>
<h4 id="推荐设置较长的超时时间：lock-lock-30-TimeUnit-SECONDS-，然后程序尝试自己解锁：lock-unlock"><a href="#推荐设置较长的超时时间：lock-lock-30-TimeUnit-SECONDS-，然后程序尝试自己解锁：lock-unlock" class="headerlink" title="推荐设置较长的超时时间：lock.lock(30, TimeUnit.SECONDS)，然后程序尝试自己解锁：lock.unlock();"></a>推荐设置较长的超时时间：<code>lock.lock(30, TimeUnit.SECONDS)</code>，然后程序尝试自己解锁：<code>lock.unlock();</code></h4><ol>
<li>可以省略自动续期操作</li>
<li>若真的超时未完成，则很有可能是数据库宕机，即使续期也无法完成，不应该无限续期下去</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试redisson实现分布式锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@ResponseBody</span><br><span class="line">@GetMapping(<span class="string">&quot;/testRedisson&quot;</span>)</span><br><span class="line">public String test() <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 1.获取锁</span></span><br><span class="line">    RLock lock = redissonClient.getLock(<span class="string">&quot;redisson_lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.加锁</span></span><br><span class="line">    <span class="comment">// 1）锁自动续期+30S，业务超长情况下（看门狗）</span></span><br><span class="line">    <span class="comment">// 2）如果线程宕机，看门狗不会自动续期，锁会自动过期</span></span><br><span class="line">    <span class="comment">// 3）unlock使用lua脚本释放锁，不会出现误删锁</span></span><br><span class="line">    lock.lock();</span><br><span class="line"></span><br><span class="line">    try <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">// 加锁成功，执行业务</span></span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功，执行业务...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">    <span class="punctuation">&#125;</span> catch (Exception e) <span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span> finally <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">// 3.解锁</span></span><br><span class="line">        System.out.println(<span class="string">&quot;解锁...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        lock.unlock();</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    return <span class="string">&quot;testRedisson&quot;</span>;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-tryLock"><a href="#2-4-tryLock" class="headerlink" title="2.4.tryLock"></a>2.4.tryLock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 尝试加锁，最多等待100秒</span></span><br><span class="line"><span class="comment">// 超时时间 30 秒</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isGetLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">100</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 成功加锁返回 true</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-公平锁"><a href="#2-5-公平锁" class="headerlink" title="2.5.公平锁"></a>2.5.公平锁</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有顺序进行加锁操作，按照请求到达的顺序</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getFairLock(<span class="string">&quot;fair-lock&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-6-读写锁"><a href="#2-6-读写锁" class="headerlink" title="2.6.读写锁"></a>2.6.读写锁</h3><h4 id="作用：保证一定能读到最新被修改的数据！"><a href="#作用：保证一定能读到最新被修改的数据！" class="headerlink" title="作用：保证一定能读到最新被修改的数据！"></a>作用：保证一定能读到最新被修改的数据！</h4><p>如果写锁被 lock，则其他操作等待；</p>
<p>否则，其他锁可以继续执行（即，读锁相当于没有加锁）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">写+读：读阻塞</span><br><span class="line">写+写：阻塞</span><br><span class="line">读+写：写阻塞</span><br><span class="line">读+读：无阻塞</span><br><span class="line"></span><br><span class="line"><span class="type">RReadWriteLock</span> <span class="variable">rwlock</span> <span class="operator">=</span> redisson.getReadWriteLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line"><span class="comment">// 读锁</span></span><br><span class="line">rwlock.readLock().lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 写锁</span></span><br><span class="line">rwlock.writeLock().lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>写锁：</p>
<p><img src="/2023/06/01/Redis/1597734236213.png" alt="1597734236213"></p>
<p>读锁：</p>
<p><img src="/2023/06/01/Redis/1597734296729.png" alt="1597734296729"></p>
<p>读锁同时存入多个：</p>
<p> <img src="/2023/06/01/Redis/1597735057026.png" alt="1597735057026"></p>
<h3 id="2-7-信号量Semphore"><a href="#2-7-信号量Semphore" class="headerlink" title="2.7.信号量Semphore"></a>2.7.信号量Semphore</h3><p>1.先设置一个值：</p>
<p>先向 redis 存入 {key: “park”, value: 3}</p>
<p>2.抢一个信号量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redisson.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取一个信号、获取一个值、占一个车位。即，信号量 -1</span></span><br><span class="line"><span class="comment">// 阻塞式</span></span><br><span class="line">park.acquire();	</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非阻塞式，看能不能获取到一个信号量</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> park.tryAcquire();	</span><br></pre></td></tr></table></figure>

<p>3.释放一个信号量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redisson.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">park.release();     <span class="comment">//释放一个车位</span></span><br></pre></td></tr></table></figure>

<h4 id="作用：限流"><a href="#作用：限流" class="headerlink" title="作用：限流"></a>作用：限流</h4><p>所有服务上来了去获取一个信号量，一个一个放行（最多只能n个线程同时执行）</p>
<p><img src="/2023/06/01/Redis/1635689277138.png" alt="1635689277138"></p>
<h3 id="2-8-闭锁CountDownLatch"><a href="#2-8-闭锁CountDownLatch" class="headerlink" title="2.8.闭锁CountDownLatch"></a>2.8.闭锁CountDownLatch</h3><p>等待一组操作执行完毕再继续执行</p>
<p><img src="/2023/06/01/Redis/1635689625640.png" alt="1635689625640"></p>
<h3 id="2-9-锁的粒度"><a href="#2-9-锁的粒度" class="headerlink" title="2.9.锁的粒度"></a>2.9.锁的粒度</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">锁的粒度一定要小，例如不应该锁整个商品操作，应该带上商品ID</span></span><br></pre></td></tr></table></figure>

<h3 id="2-10-redisson分布式锁版本"><a href="#2-10-redisson分布式锁版本" class="headerlink" title="2.10.redisson分布式锁版本"></a>2.10.redisson分布式锁版本</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询三级分类（redisson分布式锁版本）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2VO&gt;&gt; <span class="title function_">getCatalogJsonFromDBWithRedissonLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.抢占分布式锁，同时设置过期时间</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(CategoryConstant.LOCK_KEY_CATALOG_JSON);</span><br><span class="line">    lock.lock(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2.查询DB</span></span><br><span class="line">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = getCatalogJsonFromDB();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 3.释放锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">写模式，会存在数据一致性问题：</span><br><span class="line">	<span class="number">1.</span>加读写锁实现（所以对一致性高的数据不要放在缓存里）</span><br><span class="line">	<span class="number">2.</span>引入canal，感知mysql更新去更新缓存</span><br><span class="line">	<span class="number">3.</span>读多写多，直接查数据库</span><br></pre></td></tr></table></figure>

<h2 id="1-双写模式和失效模式与最终一致性（指修改数据方案）"><a href="#1-双写模式和失效模式与最终一致性（指修改数据方案）" class="headerlink" title="1.双写模式和失效模式与最终一致性（指修改数据方案）"></a>1.双写模式和失效模式与最终一致性（指修改数据方案）</h2><p>注：双写模式和失效模式都会导致数据一致性问题（写和读操作并发时导致，解决，读与写操作加读写锁）</p>
<h3 id="双写模式"><a href="#双写模式" class="headerlink" title="双写模式"></a>双写模式</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>同时写数据库和缓存</p>
<h4 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h4><p>缓存有脏数据。操作1写缓存慢于操作2写缓存，导致缓存与DB数据不一致</p>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><p>方案1：写数据库+写缓存整个加锁</p>
<p>方案2：业务是否允许暂时性数据不一致问题，若允许则给数据设置一个过期时间即可</p>
<p><img src="/2023/06/01/Redis/1635691115207.png" alt="1635691115207"></p>
<h3 id="失效模式"><a href="#失效模式" class="headerlink" title="失效模式"></a>失效模式</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><p>DB写完，删除缓存</p>
<p>注：下图有错误，用户3先读db-1，然后用户2再写db-2，用户2删缓存，用户3写缓存【写入脏数据1】</p>
<h4 id="漏洞-1"><a href="#漏洞-1" class="headerlink" title="漏洞"></a>漏洞</h4><p>缓存有脏数据。用户3将db-1写入了缓存</p>
<p><img src="/2023/06/01/Redis/1635692249946.png" alt="1635692249946"></p>
<h2 id="2-解决方案（选用失效模式）"><a href="#2-解决方案（选用失效模式）" class="headerlink" title="2.解决方案（选用失效模式）"></a>2.解决方案（选用失效模式）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">三种方案：</span><br><span class="line">	<span class="number">1.</span>仅加过期时间即可（首先考虑业务造成脏数据的概率，例如用户维度数据（订单数据、用户数据）并发几率很小，每过一段时间触发读的主动更新）</span><br><span class="line">	<span class="number">2.</span>canal订阅binlog的方式（菜单、商品介绍等基础数据）【完美解决】</span><br><span class="line">	<span class="number">3.</span>加读写锁</span><br><span class="line">	<span class="number">4.</span>实时性、一致性要求高的数据，应该直接查数据库</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="最终方案："><a href="#最终方案：" class="headerlink" title="最终方案："></a>最终方案：</h3><h4 id="1-所有数据加上过期时间"><a href="#1-所有数据加上过期时间" class="headerlink" title="1.所有数据加上过期时间"></a>1.所有数据加上过期时间</h4><h4 id="2-读写数据加分布式读写锁"><a href="#2-读写数据加分布式读写锁" class="headerlink" title="2.读写数据加分布式读写锁"></a>2.读写数据加分布式读写锁</h4><h4 id="经常写的数据不要放在缓存里"><a href="#经常写的数据不要放在缓存里" class="headerlink" title="经常写的数据不要放在缓存里"></a>经常写的数据不要放在缓存里</h4><h3 id="2-1-canal（跳过）"><a href="#2-1-canal（跳过）" class="headerlink" title="2.1.canal（跳过）"></a>2.1.canal（跳过）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">canal：</span><br><span class="line">    阿里开源的中间件，可以作为数据库的从服务器，订阅数据库的binlog日志，数据更新canal也同步更新redis</span><br><span class="line">    </span><br><span class="line">另一作用：</span><br><span class="line">    解析不同的表日志分析计算生成一张新的表记录</span><br><span class="line">    案例：</span><br><span class="line">    	根据用户访问的商品记录、订单记录 + 商品记录表共同生成一张用户推荐表，展示首页的数据（每个用户的首页推荐数据是不一样的）</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/01/Redis/1635863295094.png" alt="1635863295094"></p>
<h1 id="SpringCache"><a href="#SpringCache" class="headerlink" title="SpringCache"></a>SpringCache</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>属于 spring 内容不是 springboot，</p>
<p>Spring 对各种缓存的抽象、封装和统一。</p>
<p>Spring 希望通过注解实现缓存的使用。</p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>&lt;<a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#spring-integration">https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#spring-integration</a> &#x2F;&gt;</p>
<p><img src="/2023/06/01/Redis/1597740655126.png" alt="1597740655126"></p>
<h2 id="1-整合"><a href="#1-整合" class="headerlink" title="1.整合"></a>1.整合</h2><h3 id="1-引入SpringCache依赖"><a href="#1-引入SpringCache依赖" class="headerlink" title="1.引入SpringCache依赖"></a>1.引入SpringCache依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Cache，使用注解简化开发--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-引入redis依赖"><a href="#2-引入redis依赖" class="headerlink" title="2.引入redis依赖"></a>2.引入redis依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Spring-帮我们进行的自动配置"><a href="#3-Spring-帮我们进行的自动配置" class="headerlink" title="3.Spring 帮我们进行的自动配置"></a>3.Spring 帮我们进行的自动配置</h3><p>这一步只是查看一下自动配置类+属性类，没有实际编码动作</p>
<p>1）自动配置以下内容：</p>
<ul>
<li>属性类：CacheProperties.java【属性以 spring.cache 开头】</li>
<li>自动配置类：CacheAutoConfiguration.java【会导入 RedisCacheConfiguration 配置】</li>
<li>redis 自动配置类：RedisCacheConfiguration.java【往IOC注入了redis缓存管理器】</li>
<li>redis 缓存管理器：RedisCacheManager【会初始化所有缓存（决定每个缓存使用什么配置）】</li>
<li>【如果 RedisCacheConfiguration 有就使用，没有就使用默认的（导致缓存使用默认配置，默认配置值来自于this.cacheProperties.getRedis()）】</li>
<li>注：缓存区域化只是springcache的内容，在redis里数据存放没有区域化的概念，体现为 name::key</li>
</ul>
<h3 id="4-关键注解"><a href="#4-关键注解" class="headerlink" title="4.关键注解"></a>4.关键注解</h3><p>在方法上使用</p>
<ul>
<li>@Cacheable：保存缓存【读操作：如果当前缓存存在，则被标注的方法不被执行，不存在则执行这个方法并更新缓存】</li>
<li>@CacheEvict：删除缓存【写操作：使用数据一致性保证中的失效模式，方法执行完删除缓存】</li>
<li>@CachePut：更新缓存【写操作：使用数据一致性保证中的双写模式，方法执行完更新缓存】</li>
<li>@Caching：组合以上多个缓存操作</li>
<li>@CacheConfig：在类级别共享缓存的相同配置</li>
</ul>
<h3 id="5-application-yml"><a href="#5-application-yml" class="headerlink" title="5.application.yml"></a>5.application.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span> <span class="comment"># 使用redis作为缓存</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">time-to-live:</span> <span class="string">3600s</span> <span class="comment"># 过期时间</span></span><br><span class="line">      <span class="comment"># key-prefix: CACHE_ # 会导致自己在 @Cacheable 里设置的名字失效，所以这里不指定</span></span><br><span class="line">      <span class="attr">use-key-prefix:</span> <span class="literal">true</span> <span class="comment"># key 值加前缀</span></span><br><span class="line">      <span class="attr">cache-null-values:</span> <span class="literal">true</span> <span class="comment"># 缓存存储 null，防止缓存穿透</span></span><br></pre></td></tr></table></figure>

<h3 id="6-默认行为"><a href="#6-默认行为" class="headerlink" title="6.默认行为"></a>6.默认行为</h3><ul>
<li>redis 中真实 key 名自动生成规则：缓存名字::key 值。@Cacheable(name, key)，name 是缓存名字</li>
<li>默认过期时间：-1。永不过期</li>
<li>value值默认序列化方式：jdk序列化【值使用 jdk 序列化数据后存放到redis】</li>
</ul>
<h3 id="7-自定义行为"><a href="#7-自定义行为" class="headerlink" title="7.自定义行为"></a>7.自定义行为</h3><ul>
<li><p>缓存名字：<code>@Cacheable(value = &#123;&quot;category&quot;&#125;)</code>【区域划分】</p>
</li>
<li><p>key值：<code>@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#39;levelCategorys&#39;&quot;)</code></p>
<p>【redis 中的真实 key 显示为 <code>category::levelCategorys</code>】<br>【key 可以接收接收一个 SpEl 表达式，可以获取当前方法名，参数列表，单引号表字符串】<br>【例如，使用方法名作为 key：”#root.method.name”：<code>@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;#root.method.name&quot;)</code>】</p>
</li>
<li><p>过期时间：在 application.yml 中指定。见上 5.application.yml</p>
</li>
<li><p>修改序列化方式要在配置类中修改</p>
</li>
</ul>
<h3 id="8-配置类【添加-EnableCache-使用springcache】"><a href="#8-配置类【添加-EnableCache-使用springcache】" class="headerlink" title="8.配置类【添加 @EnableCache 使用springcache】"></a>8.配置类【添加 @EnableCache 使用springcache】</h3><p>我们编写一个配置类来总管缓存相关配置。</p>
<p>config&#x2F;MyCacheConfig.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCacheConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要将配置文件中的配置设置上</span></span><br><span class="line"><span class="comment">     * 1、使配置类生效</span></span><br><span class="line"><span class="comment">     * 	方法 1：开启配置类与属性绑定功能 <span class="doctag">@EnableConfigurationProperties</span></span></span><br><span class="line"><span class="comment">     * 		源码：</span></span><br><span class="line"><span class="comment">     * 		<span class="doctag">@ConfigurationProperties</span>(prefix = &quot;spring.cache&quot;)  </span></span><br><span class="line"><span class="comment">     * 		public class CacheProperties&#123;&#125;</span></span><br><span class="line"><span class="comment">     * 	方法 2：注入就可以使用了</span></span><br><span class="line"><span class="comment">     * 		<span class="doctag">@Autowired</span> CacheProperties cacheProperties;</span></span><br><span class="line"><span class="comment">     * 	方法 3：直接在需要的方法参数中加入属性参数 redisCacheConfiguration(CacheProperties redisProperties)</span></span><br><span class="line"><span class="comment">     * 		CacheProperties 自动从 IOC 容器中找</span></span><br><span class="line"><span class="comment">     * 	&lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 2、给 config 设置上</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedisCacheConfiguration <span class="title function_">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> &#123;</span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        <span class="comment">// 设置 redis key 的存储格式</span></span><br><span class="line">        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>()));</span><br><span class="line">        <span class="comment">// 设置 redis value 的序列化方式</span></span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当自己往IOC注入了 RedisCacheConfiguration 配置类时，以下参数全都失效，全部需要手动设置</span></span><br><span class="line">        CacheProperties.<span class="type">Redis</span> <span class="variable">redisProperties</span> <span class="operator">=</span> cacheProperties.getRedis();</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="literal">null</span>) &#123;	</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.prefixCacheNameWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>.yml 文件中的内容，需要在配置类中使用 <code>CacheProperties cacheProperties</code> 激活</p>
<h3 id="9-使用案例：在-service-层代码上添加注解"><a href="#9-使用案例：在-service-层代码上添加注解" class="headerlink" title="9.使用案例：在 service 层代码上添加注解"></a>9.使用案例：在 service 层代码上添加注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 查出所有1级分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Categorys</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用了getLevel1Categorys...&quot;</span>);</span><br><span class="line">    <span class="comment">// 查询父id=0</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>redis缓存管理器源码，会初始化过期时间、key前缀、空数据是否缓存、是否使用缓存前缀</p>
<p><img src="/2023/06/01/Redis/1636030148580.png" alt="1636030148580"></p>
<h2 id="2-读模式与写模式"><a href="#2-读模式与写模式" class="headerlink" title="2.读模式与写模式"></a>2.读模式与写模式</h2><h3 id="2-1-读模式"><a href="#2-1-读模式" class="headerlink" title="2.1.读模式"></a>2.1.读模式</h3><p>缓存穿透：查询一个[永不]不存在的数据。解决：缓存存储 null</p>
<p>缓存雪崩：大量的 key 同时过期。</p>
<p>缓存击穿：正好查询一个过期的数据。解决：加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">直接在get方法上添加<span class="meta">@Cacheable</span>即可</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查出所有1级分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Categorys</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用了getLevel1Categorys...&quot;</span>);</span><br><span class="line">    <span class="comment">// 查询父id=0</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-写模式"><a href="#2-2-写模式" class="headerlink" title="2.2.写模式"></a>2.2.写模式</h3><p>解决保证缓存的一致性问题： </p>
<h4 id="失效模式-1"><a href="#失效模式-1" class="headerlink" title="失效模式"></a>失效模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 级联更新</span></span><br><span class="line"><span class="comment"> * 缓存策略：失效模式，方法执行完删除缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(category.getName())) &#123;</span><br><span class="line">        <span class="comment">// 更新冗余表</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">        <span class="comment">// TODO 更新其他冗余表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="双写模式-1"><a href="#双写模式-1" class="headerlink" title="双写模式"></a>双写模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 级联更新</span></span><br><span class="line"><span class="comment"> * 缓存策略：双写模式，方法执行完更新缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CachePut(value = &quot;category&quot;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(category.getName())) &#123;</span><br><span class="line">        <span class="comment">// 更新冗余表</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">        <span class="comment">// TODO 更新其他冗余表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Caching-失效模式-解决击穿、雪崩、穿透（分布式锁）"><a href="#2-3-Caching-失效模式-解决击穿、雪崩、穿透（分布式锁）" class="headerlink" title="2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）"></a>2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">失效模式，级联更新类型时，删除与类型相关的所有缓存</span><br><span class="line"></span><br><span class="line">两种方式：</span><br><span class="line">    方式<span class="number">1</span>：指定每个key</span><br><span class="line">    <span class="meta">@Caching(evict = &#123;</span></span><br><span class="line"><span class="meta">        @CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;),</span></span><br><span class="line"><span class="meta">        @CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    </span><br><span class="line">    方式<span class="number">2</span>：直接删除区域化内所有缓存</span><br><span class="line">    <span class="meta">@CacheEvict(value = &#123;&quot;category&quot;&#125;, allEntries = true)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 级联更新所有关联表的冗余数据</span></span><br><span class="line"><span class="comment"> * 缓存策略：失效模式，方法执行完删除缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &#123;&quot;category&quot;&#125;, allEntries = true)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(category.getName())) &#123;</span><br><span class="line">        <span class="comment">// 更新冗余表</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">        <span class="comment">// TODO 更新其他冗余表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查出所有1级分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Categorys</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用了getLevel1Categorys...&quot;</span>);</span><br><span class="line">    <span class="comment">// 查询父id=0</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询三级分类并封装成Map返回</span></span><br><span class="line"><span class="comment"> * 使用SpringCache注解方式简化缓存设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2VO&gt;&gt; <span class="title function_">getCatalogJsonWithSpringCache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 未命中缓存</span></span><br><span class="line">    <span class="comment">// 1.抢占分布式锁，同时设置过期时间【不使用读写锁，因为就是为了防止缓存击穿】</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(CategoryConstant.LOCK_KEY_CATALOG_JSON);</span><br><span class="line">    lock.lock(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2.double check，占锁成功需要再次检查缓存</span></span><br><span class="line">        <span class="comment">// 查询非空即返回</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catlogJSON</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;getCatalogJson&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(catlogJSON)) &#123;</span><br><span class="line">            <span class="comment">// 查询成功直接返回不需要查询DB</span></span><br><span class="line">            Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = JSON.parseObject(catlogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catalog2VO&gt;&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.查询所有分类，按照parentCid分组</span></span><br><span class="line">        Map&lt;Long, List&lt;CategoryEntity&gt;&gt; categoryMap = baseMapper.selectList(<span class="literal">null</span>).stream()</span><br><span class="line">                .collect(Collectors.groupingBy(key -&gt; key.getParentCid()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.获取1级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; level1Categorys = categoryMap.get(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.封装数据</span></span><br><span class="line">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = level1Categorys.stream().collect(Collectors.toMap(key -&gt; key.getCatId().toString(), l1Category -&gt; &#123;</span><br><span class="line">            <span class="comment">// 6.查询2级分类，并封装成List&lt;Catalog2VO&gt;</span></span><br><span class="line">            List&lt;Catalog2VO&gt; catalog2VOS = categoryMap.get(l1Category.getCatId())</span><br><span class="line">                    .stream().map(l2Category -&gt; &#123;</span><br><span class="line">                        <span class="comment">// 7.查询3级分类，并封装成List&lt;Catalog3VO&gt;</span></span><br><span class="line">                        List&lt;Catalog2VO.Catalog3Vo&gt; catalog3Vos = categoryMap.get(l2Category.getCatId())</span><br><span class="line">                                .stream().map(l3Category -&gt; &#123;</span><br><span class="line">                                    <span class="comment">// 封装3级分类VO</span></span><br><span class="line">                                    Catalog2VO.<span class="type">Catalog3Vo</span> <span class="variable">catalog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catalog2VO</span>.Catalog3Vo(l2Category.getCatId().toString(), l3Category.getCatId().toString(), l3Category.getName());</span><br><span class="line">                                    <span class="keyword">return</span> catalog3Vo;</span><br><span class="line">                                &#125;).collect(Collectors.toList());</span><br><span class="line">                        <span class="comment">// 封装2级分类VO返回</span></span><br><span class="line">                        <span class="type">Catalog2VO</span> <span class="variable">catalog2VO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catalog2VO</span>(l1Category.getCatId().toString(), catalog3Vos, l2Category.getCatId().toString(), l2Category.getName());</span><br><span class="line">                        <span class="keyword">return</span> catalog2VO;</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> catalog2VOS;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 8.释放锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-细节"><a href="#4-细节" class="headerlink" title="4.细节"></a>4.细节</h2><h3 id="2-1-ConfigurationProperties标注方法上使用"><a href="#2-1-ConfigurationProperties标注方法上使用" class="headerlink" title="2.1.@ConfigurationProperties标注方法上使用"></a>2.1.@ConfigurationProperties标注方法上使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">使用<span class="meta">@ConfigurationProperties</span>标注在方法上使用时必须配合<span class="meta">@Bean</span> + <span class="meta">@Configuration</span>使用</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;readDruidDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">readDruidDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.write&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;writeDruidDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">writeDruidDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.druid.write.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.write.password</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">spring.datasource.druid.write.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.druid.read.url</span>=<span class="string">jdbc:mysql://localhost:3306/jpa</span></span><br><span class="line"><span class="attr">spring.datasource.druid.read.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.druid.read.password</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">spring.datasource.druid.read.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-ConfigurationProperties标注类上使用"><a href="#2-2-ConfigurationProperties标注类上使用" class="headerlink" title="2.2.@ConfigurationProperties标注类上使用"></a>2.2.@ConfigurationProperties标注类上使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatasourcePro</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">// 配置文件中是driver-class-name, 转驼峰命名便可以绑定成</span></span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigurationPropertiesController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DatasourcePro datasourcePro;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;url&quot;</span>, datasourcePro.getUrl());</span><br><span class="line">        map.put(<span class="string">&quot;userName&quot;</span>, datasourcePro.getUsername());</span><br><span class="line">        map.put(<span class="string">&quot;password&quot;</span>, datasourcePro.getPassword());</span><br><span class="line">        map.put(<span class="string">&quot;className&quot;</span>, datasourcePro.getDriverClassName());</span><br><span class="line">        map.put(<span class="string">&quot;type&quot;</span>, datasourcePro.getType());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:8888/test?useUnicode=false&amp;autoReconnect=true&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-EnableConfigurationProperties标注在类上使用"><a href="#2-3-EnableConfigurationProperties标注在类上使用" class="headerlink" title="2.3. @EnableConfigurationProperties标注在类上使用"></a>2.3. @EnableConfigurationProperties标注在类上使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;readDruidDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">readDruidDataSource</span><span class="params">(JDBCProperties properties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">// dataSource.setUrl(properties.getXX)</span></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.write&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;writeDruidDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">writeDruidDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-spring-cache不足"><a href="#5-spring-cache不足" class="headerlink" title="5.spring-cache不足"></a>5.spring-cache不足</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、读模式:</span><br><span class="line">	缓存穿透:查询一个DB不存在的数据。解决:缓存空数据;ache-<span class="literal">null</span>-values=<span class="literal">true</span>【布隆过滤器】</span><br><span class="line">	缓存击穿:大量并发进来同时查询一个正好过期的数据。解决:加锁; 默认未加锁【sync = <span class="literal">true</span>】只是本地锁</span><br><span class="line">	缓存雪崩:大量的key同时过期。解决:加上过期时间。: spring.cache.redis.time-to-live= 360000s</span><br><span class="line"><span class="number">2</span>、写模式:（缓存与数据库一致)（没有解决）</span><br><span class="line">	<span class="number">1</span>)、手动读写加锁。</span><br><span class="line">	<span class="number">2</span>)、引入canal，感知mysql的更新去更新缓存</span><br><span class="line">	<span class="number">3</span>)、读多写多，直接去查询数据库就行</span><br><span class="line">	</span><br><span class="line">总结:</span><br><span class="line">	常规数据（读多写少，即时性，一致性要求不高的数据）﹔完全可以使用Spring-Cache，写模式(只要缓存的数据有过期时间就可以）</span><br><span class="line">	特殊数据:特殊设计（canal、读写锁）</span><br><span class="line"></span><br><span class="line">                                                     </span><br><span class="line">在RedisCache里面打断点查看get同步方法</span><br></pre></td></tr></table></figure>

<h3 id="最终版：失效模式-解决击穿、雪崩、穿透（本地锁）"><a href="#最终版：失效模式-解决击穿、雪崩、穿透（本地锁）" class="headerlink" title="最终版：失效模式+解决击穿、雪崩、穿透（本地锁）"></a>最终版：失效模式+解决击穿、雪崩、穿透（本地锁）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 级联更新所有关联表的冗余数据</span></span><br><span class="line"><span class="comment"> * 缓存策略：失效模式，方法执行完删除缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &#123;&quot;category&quot;&#125;, allEntries = true)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(category.getName())) &#123;</span><br><span class="line">        <span class="comment">// 更新冗余表</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">        <span class="comment">// TODO 更新其他冗余表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查出所有1级分类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;, sync = true)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Categorys</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用了getLevel1Categorys...&quot;</span>);</span><br><span class="line">    <span class="comment">// 查询父id=0</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询三级分类并封装成Map返回</span></span><br><span class="line"><span class="comment"> * 使用SpringCache注解方式简化缓存设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getCatalogJson&#x27;&quot;, sync = true)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2VO&gt;&gt; <span class="title function_">getCatalogJsonWithSpringCache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 未命中缓存</span></span><br><span class="line">    <span class="comment">// 1.double check，占锁成功需要再次检查缓存（springcache使用本地锁）</span></span><br><span class="line">    <span class="comment">// 查询非空即返回</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catlogJSON</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;getCatalogJson&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(catlogJSON)) &#123;</span><br><span class="line">        <span class="comment">// 查询成功直接返回不需要查询DB</span></span><br><span class="line">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = JSON.parseObject(catlogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catalog2VO&gt;&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.查询所有分类，按照parentCid分组</span></span><br><span class="line">    Map&lt;Long, List&lt;CategoryEntity&gt;&gt; categoryMap = baseMapper.selectList(<span class="literal">null</span>).stream()</span><br><span class="line">            .collect(Collectors.groupingBy(key -&gt; key.getParentCid()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.获取1级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; level1Categorys = categoryMap.get(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.封装数据</span></span><br><span class="line">    Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = level1Categorys.stream().collect(Collectors.toMap(key -&gt; key.getCatId().toString(), l1Category -&gt; &#123;</span><br><span class="line">        <span class="comment">// 5.查询2级分类，并封装成List&lt;Catalog2VO&gt;</span></span><br><span class="line">        List&lt;Catalog2VO&gt; catalog2VOS = categoryMap.get(l1Category.getCatId())</span><br><span class="line">                .stream().map(l2Category -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 7.查询3级分类，并封装成List&lt;Catalog3VO&gt;</span></span><br><span class="line">                    List&lt;Catalog2VO.Catalog3Vo&gt; catalog3Vos = categoryMap.get(l2Category.getCatId())</span><br><span class="line">                            .stream().map(l3Category -&gt; &#123;</span><br><span class="line">                                <span class="comment">// 封装3级分类VO</span></span><br><span class="line">                                Catalog2VO.<span class="type">Catalog3Vo</span> <span class="variable">catalog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catalog2VO</span>.Catalog3Vo(l2Category.getCatId().toString(), l3Category.getCatId().toString(), l3Category.getName());</span><br><span class="line">                                <span class="keyword">return</span> catalog3Vo;</span><br><span class="line">                            &#125;).collect(Collectors.toList());</span><br><span class="line">                    <span class="comment">// 封装2级分类VO返回</span></span><br><span class="line">                    <span class="type">Catalog2VO</span> <span class="variable">catalog2VO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catalog2VO</span>(l1Category.getCatId().toString(), catalog3Vos, l2Category.getCatId().toString(), l2Category.getName());</span><br><span class="line">                    <span class="keyword">return</span> catalog2VO;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> catalog2VOS;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="StringRedisTemplate"><a href="#StringRedisTemplate" class="headerlink" title="StringRedisTemplate"></a>StringRedisTemplate</h1><h2 id="1-一些使用案例"><a href="#1-一些使用案例" class="headerlink" title="1.一些使用案例"></a>1.一些使用案例</h2><h3 id="1-1-BoundHashOperations"><a href="#1-1-BoundHashOperations" class="headerlink" title="1.1.BoundHashOperations"></a>1.1.BoundHashOperations</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户信息获取购物车redis操作对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> BoundHashOperations&lt;String, Object, Object&gt; <span class="title function_">getCartOps</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取用户登录信息</span></span><br><span class="line">    <span class="type">UserInfoTO</span> <span class="variable">userInfo</span> <span class="operator">=</span> CartInterceptor.threadLocal.get();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cartKey</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (userInfo.getUserId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 登录态，使用用户购物车</span></span><br><span class="line">        cartKey = CartConstant.CART_PREFIX + userInfo.getUserId();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非登录态，使用游客购物车</span></span><br><span class="line">        cartKey = CartConstant.CART_PREFIX + userInfo.getUserKey();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 绑定购物车的key操作Redis</span></span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; operations = redisTemplate.boundHashOps(cartKey);</span><br><span class="line">    <span class="keyword">return</span> operations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>get方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据skuId获取购物车商品信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CartItemVO <span class="title function_">getCartItem</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取购物车redis操作对象</span></span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cartItemJSONString</span> <span class="operator">=</span> (String) cartOps.get(skuId.toString());</span><br><span class="line">    <span class="type">CartItemVO</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> JSON.parseObject(cartItemJSONString, CartItemVO.class);</span><br><span class="line">    <span class="keyword">return</span> cartItemVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>put方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加sku商品到购物车</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CartItemVO <span class="title function_">addToCart</span><span class="params">(Long skuId, Integer num)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 获取购物车redis操作对象</span></span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; operations = getCartOps();</span><br><span class="line">    <span class="comment">// 获取商品</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cartItemJSONString</span> <span class="operator">=</span> (String) operations.get(skuId.toString());</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(cartItemJSONString)) &#123;</span><br><span class="line">        <span class="comment">// 购物车不存在此商品，需要将当前商品添加到购物车中</span></span><br><span class="line">        <span class="type">CartItemVO</span> <span class="variable">cartItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CartItemVO</span>();</span><br><span class="line">        CompletableFuture&lt;Void&gt; getSkuInfoFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 远程查询当前商品信息</span></span><br><span class="line">            <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.getInfo(skuId);</span><br><span class="line">            <span class="type">SkuInfoVO</span> <span class="variable">skuInfo</span> <span class="operator">=</span> r.getData(<span class="string">&quot;skuInfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SkuInfoVO&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            cartItem.setSkuId(skuInfo.getSkuId());<span class="comment">// 商品ID</span></span><br><span class="line">            cartItem.setTitle(skuInfo.getSkuTitle());<span class="comment">// 商品标题</span></span><br><span class="line">            cartItem.setImage(skuInfo.getSkuDefaultImg());<span class="comment">// 商品默认图片</span></span><br><span class="line">            cartItem.setPrice(skuInfo.getPrice());<span class="comment">// 商品单价</span></span><br><span class="line">            cartItem.setCount(num);<span class="comment">// 商品件数</span></span><br><span class="line">            cartItem.setCheck(<span class="literal">true</span>);<span class="comment">// 是否选中</span></span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;Void&gt; getSkuAttrValuesFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 远程查询attrName:attrValue信息</span></span><br><span class="line">            List&lt;String&gt; skuSaleAttrValues = productFeignService.getSkuSaleAttrValues(skuId);</span><br><span class="line">            cartItem.setSkuAttrValues(skuSaleAttrValues);</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        CompletableFuture.allOf(getSkuInfoFuture, getSkuAttrValuesFuture).get();</span><br><span class="line">        operations.put(skuId.toString(), JSON.toJSONString(cartItem));</span><br><span class="line">        <span class="keyword">return</span> cartItem;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 当前购物车已存在此商品，修改当前商品数量</span></span><br><span class="line">        <span class="type">CartItemVO</span> <span class="variable">cartItem</span> <span class="operator">=</span> JSON.parseObject(cartItemJSONString, CartItemVO.class);</span><br><span class="line">        cartItem.setCount(cartItem.getCount() + num);</span><br><span class="line">        operations.put(skuId.toString(), JSON.toJSONString(cartItem));</span><br><span class="line">        <span class="keyword">return</span> cartItem;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://superchen7.github.io">superchen7</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://superchen7.github.io/2023/06/01/Redis/">http://superchen7.github.io/2023/06/01/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://superchen7.github.io" target="_blank">superchen的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/redis/">redis</a><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post_share"><div class="social-share" data-image="/img/touxiang.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/01/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88RabbitMQ%EF%BC%89/" title="消息中间件（RabbitMQ）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">消息中间件（RabbitMQ）</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/03/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="java多线程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">java多线程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/01/03/%E5%AE%9E%E7%8E%B0%E8%AE%A2%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8F%96%E6%B6%88%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/" title="实现订单自动取消的三种方式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-03</div><div class="title">实现订单自动取消的三种方式</div></div></a></div><div><a href="/2023/12/01/springcache%E8%A7%A3%E5%86%B3redis%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%9B%AA%E5%B4%A9/" title="springcache的使用以及解决redis缓存击穿、穿透、雪崩"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-01</div><div class="title">springcache的使用以及解决redis缓存击穿、穿透、雪崩</div></div></a></div><div><a href="/2023/07/19/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95+%E4%BC%98%E5%8C%96%EF%BC%88Jmeter%EF%BC%89/" title="压力测试+优化（Jmeter）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-19</div><div class="title">压力测试+优化（Jmeter）</div></div></a></div><div><a href="/2023/07/01/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88RabbitMQ%EF%BC%89/" title="消息中间件（RabbitMQ）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-01</div><div class="title">消息中间件（RabbitMQ）</div></div></a></div><div><a href="/2022/06/03/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="java多线程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-03</div><div class="title">java多线程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">superchen7</div><div class="author-info__description">人生路长，坚持就好</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/superchen7" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:suchenzzzz@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%80%82%E5%90%88%E6%94%BE%E5%85%A5%E7%BC%93%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.</span> <span class="toc-text">1.适合放入缓存的数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8D%B3%E6%97%B6%E6%80%A7%E3%80%81%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E8%A6%81%E6%B1%82%E4%B8%8D%E9%AB%98%E7%9A%84"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.即时性、数据一致性要求不高的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AE%BF%E9%97%AE%E9%87%8F%E5%A4%A7%E4%B8%94%E6%9B%B4%E6%96%B0%E9%A2%91%E7%8E%87%E4%B8%8D%E9%AB%98%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%88%E8%AF%BB%E5%A4%9A%EF%BC%8C%E5%86%99%E5%B0%91%EF%BC%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.访问量大且更新频率不高的数据（读多，写少）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AF%BB%E6%A8%A1%E5%BC%8F%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2.读模式缓存使用流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%B8%8E%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.3.</span> <span class="toc-text">3.本地缓存与局限性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.</span> <span class="toc-text">4.分布式缓存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E5%90%88redis"><span class="toc-number">2.</span> <span class="toc-text">整合redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8springboot%E6%95%B4%E5%90%88redis"><span class="toc-number">2.1.</span> <span class="toc-text">1.使用springboot整合redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9C%A8%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8redis%E7%9A%84%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.在需要使用redis的模块导入依赖，启动器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-RedisAutoConfiguration-%E6%9F%A5%E7%9C%8B%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.RedisAutoConfiguration 查看自动配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8-SpringBoot-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%A5%BD%E7%9A%84-RedisTemplate-%E6%88%96%E8%80%85-StringRedisTemplate-%E5%8D%B3%E5%8F%AF%E6%93%8D%E4%BD%9C-redis"><span class="toc-number">2.1.3.</span> <span class="toc-text">3.使用 SpringBoot 自动配置好的 RedisTemplate 或者 StringRedisTemplate 即可操作 redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">2.单元测试用例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-lettuce-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%EF%BC%88springboot-2-3-2-%E5%B7%B2%E8%A7%A3%E5%86%B3%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">3.lettuce 堆外内存溢出（springboot 2.3.2 已解决）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-lettuce%E3%80%81jedis%E3%80%81redistemplate"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1.lettuce、jedis、redistemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2.原因</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">异常描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A%E5%88%87%E6%8D%A2-jedis%EF%BC%88%E6%B3%A8%E6%84%8F-springboot-2-3-2-%E5%B7%B2%E4%BF%AE%E5%A4%8D%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%89"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3.解决方法：切换 jedis（注意 springboot 2.3.2 已修复这个问题）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">4.缓存失效问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%EF%BC%88%E6%95%B0%E6%8D%AE%E4%B8%8D%E5%9C%A8%E7%BC%93%E5%AD%98%EF%BC%89"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1.缓存穿透（数据不在缓存）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A3%8E%E9%99%A9"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">风险</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%EF%BC%88%E7%BC%93%E5%AD%98%E5%A4%A7%E9%9D%A2%E7%A7%AF%E5%A4%B1%E6%95%88%EF%BC%89"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2.缓存雪崩（缓存大面积失效）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%EF%BC%88%E4%B8%80%E6%9D%A1%E5%A4%B1%E6%95%88%EF%BC%89"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3.缓存击穿（一条失效）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E9%94%81%E6%97%B6%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.4.</span> <span class="toc-text">4.4.锁时效问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%A8%A1%E6%8B%9F%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%AC%E5%9C%B0%E9%94%81%E5%A4%B1%E6%95%88"><span class="toc-number">2.4.5.</span> <span class="toc-text">4.5.模拟分布式本地锁失效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.5.</span> <span class="toc-text">5.分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%BC%94%E7%A4%BA%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-SET-NX"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1.演示分布式锁 SET NX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E9%97%AE%E9%A2%98%E5%90%88%E9%9B%86"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2.问题合集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%981%EF%BC%9A%E5%88%A0%E9%99%A4%E9%94%81"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">问题1：删除锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%982%EF%BC%9A%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">问题2：设置过期时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%983%EF%BC%9A%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">2.5.2.3.</span> <span class="toc-text">问题3：设置过期时间的原子性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%984%EF%BC%9A%E4%BB%85%E5%8F%AF%E4%BB%A5%E5%88%A0%E9%99%A4%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E5%8D%A0%E7%94%A8%E7%9A%84%E9%94%81"><span class="toc-number">2.5.2.4.</span> <span class="toc-text">问题4：仅可以删除当前线程占用的锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%89%88%E6%9C%AC"><span class="toc-number">2.5.3.</span> <span class="toc-text">5.3.redis分布式锁版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redisson"><span class="toc-number">3.</span> <span class="toc-text">Redisson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">1.概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-%E5%8E%9F%E7%94%9F%E7%9A%84-redisson-%E7%9C%8B%E9%97%A8%E7%8B%97"><span class="toc-number">3.2.</span> <span class="toc-text">2.使用 原生的 redisson(看门狗)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.0.1.</span> <span class="toc-text">单元测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1.可重入锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E3%80%81%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F%E3%80%81%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE%EF%BC%88lua%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2.过期时间、自动续期、手动释放（lua原子操作）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%8C%87%E5%AE%9A%E8%B6%85%E6%97%B6%EF%BC%8C%E4%B8%8D%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3.指定超时，不自动续期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E8%AE%BE%E7%BD%AE%E8%BE%83%E9%95%BF%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%EF%BC%9Alock-lock-30-TimeUnit-SECONDS-%EF%BC%8C%E7%84%B6%E5%90%8E%E7%A8%8B%E5%BA%8F%E5%B0%9D%E8%AF%95%E8%87%AA%E5%B7%B1%E8%A7%A3%E9%94%81%EF%BC%9Alock-unlock"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">推荐设置较长的超时时间：lock.lock(30, TimeUnit.SECONDS)，然后程序尝试自己解锁：lock.unlock();</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-tryLock"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.4.tryLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">3.2.5.</span> <span class="toc-text">2.5.公平锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">3.2.6.</span> <span class="toc-text">2.6.读写锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%EF%BC%9A%E4%BF%9D%E8%AF%81%E4%B8%80%E5%AE%9A%E8%83%BD%E8%AF%BB%E5%88%B0%E6%9C%80%E6%96%B0%E8%A2%AB%E4%BF%AE%E6%94%B9%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%81"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">作用：保证一定能读到最新被修改的数据！</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E4%BF%A1%E5%8F%B7%E9%87%8FSemphore"><span class="toc-number">3.2.7.</span> <span class="toc-text">2.7.信号量Semphore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%EF%BC%9A%E9%99%90%E6%B5%81"><span class="toc-number">3.2.7.1.</span> <span class="toc-text">作用：限流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E9%97%AD%E9%94%81CountDownLatch"><span class="toc-number">3.2.8.</span> <span class="toc-text">2.8.闭锁CountDownLatch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E9%94%81%E7%9A%84%E7%B2%92%E5%BA%A6"><span class="toc-number">3.2.9.</span> <span class="toc-text">2.9.锁的粒度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%89%88%E6%9C%AC"><span class="toc-number">3.2.10.</span> <span class="toc-text">2.10.redisson分布式锁版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">数据一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%8C%E5%86%99%E6%A8%A1%E5%BC%8F%E5%92%8C%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88%E6%8C%87%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">1.双写模式和失效模式与最终一致性（指修改数据方案）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%86%99%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.1.</span> <span class="toc-text">双写模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">失效模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E-1"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">漏洞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%88%E9%80%89%E7%94%A8%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">2.解决方案（选用失效模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">4.2.1.</span> <span class="toc-text">最终方案：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%8A%A0%E4%B8%8A%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">1.所有数据加上过期时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%AF%BB%E5%86%99%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">2.读写数据加分布式读写锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E5%B8%B8%E5%86%99%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8D%E8%A6%81%E6%94%BE%E5%9C%A8%E7%BC%93%E5%AD%98%E9%87%8C"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">经常写的数据不要放在缓存里</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-canal%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.1.canal（跳过）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCache"><span class="toc-number">5.</span> <span class="toc-text">SpringCache</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3"><span class="toc-number">5.2.</span> <span class="toc-text">文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B4%E5%90%88"><span class="toc-number">5.3.</span> <span class="toc-text">1.整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%95%E5%85%A5SpringCache%E4%BE%9D%E8%B5%96"><span class="toc-number">5.3.1.</span> <span class="toc-text">1.引入SpringCache依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%95%E5%85%A5redis%E4%BE%9D%E8%B5%96"><span class="toc-number">5.3.2.</span> <span class="toc-text">2.引入redis依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Spring-%E5%B8%AE%E6%88%91%E4%BB%AC%E8%BF%9B%E8%A1%8C%E7%9A%84%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.Spring 帮我们进行的自动配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B3%E9%94%AE%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.3.4.</span> <span class="toc-text">4.关键注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-application-yml"><span class="toc-number">5.3.5.</span> <span class="toc-text">5.application.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E9%BB%98%E8%AE%A4%E8%A1%8C%E4%B8%BA"><span class="toc-number">5.3.6.</span> <span class="toc-text">6.默认行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%8C%E4%B8%BA"><span class="toc-number">5.3.7.</span> <span class="toc-text">7.自定义行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E9%85%8D%E7%BD%AE%E7%B1%BB%E3%80%90%E6%B7%BB%E5%8A%A0-EnableCache-%E4%BD%BF%E7%94%A8springcache%E3%80%91"><span class="toc-number">5.3.8.</span> <span class="toc-text">8.配置类【添加 @EnableCache 使用springcache】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%9C%A8-service-%E5%B1%82%E4%BB%A3%E7%A0%81%E4%B8%8A%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.3.9.</span> <span class="toc-text">9.使用案例：在 service 层代码上添加注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AF%BB%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%86%99%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.4.</span> <span class="toc-text">2.读模式与写模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%AF%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.4.1.</span> <span class="toc-text">2.1.读模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%86%99%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.4.2.</span> <span class="toc-text">2.2.写模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">失效模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E5%86%99%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">双写模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Caching-%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F-%E8%A7%A3%E5%86%B3%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%89"><span class="toc-number">5.4.3.</span> <span class="toc-text">2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BB%86%E8%8A%82"><span class="toc-number">5.5.</span> <span class="toc-text">4.细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-ConfigurationProperties%E6%A0%87%E6%B3%A8%E6%96%B9%E6%B3%95%E4%B8%8A%E4%BD%BF%E7%94%A8"><span class="toc-number">5.5.1.</span> <span class="toc-text">2.1.@ConfigurationProperties标注方法上使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-ConfigurationProperties%E6%A0%87%E6%B3%A8%E7%B1%BB%E4%B8%8A%E4%BD%BF%E7%94%A8"><span class="toc-number">5.5.2.</span> <span class="toc-text">2.2.@ConfigurationProperties标注类上使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-EnableConfigurationProperties%E6%A0%87%E6%B3%A8%E5%9C%A8%E7%B1%BB%E4%B8%8A%E4%BD%BF%E7%94%A8"><span class="toc-number">5.5.3.</span> <span class="toc-text">2.3. @EnableConfigurationProperties标注在类上使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-spring-cache%E4%B8%8D%E8%B6%B3"><span class="toc-number">5.6.</span> <span class="toc-text">5.spring-cache不足</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%89%88%EF%BC%9A%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F-%E8%A7%A3%E5%86%B3%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%EF%BC%88%E6%9C%AC%E5%9C%B0%E9%94%81%EF%BC%89"><span class="toc-number">5.6.1.</span> <span class="toc-text">最终版：失效模式+解决击穿、雪崩、穿透（本地锁）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#StringRedisTemplate"><span class="toc-number">6.</span> <span class="toc-text">StringRedisTemplate</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">6.1.</span> <span class="toc-text">1.一些使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-BoundHashOperations"><span class="toc-number">6.1.1.</span> <span class="toc-text">1.1.BoundHashOperations</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/03/%E5%AE%9E%E7%8E%B0%E8%AE%A2%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8F%96%E6%B6%88%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/" title="实现订单自动取消的三种方式">实现订单自动取消的三种方式</a><time datetime="2024-01-03T05:06:22.000Z" title="发表于 2024-01-03 13:06:22">2024-01-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/01/springcache%E8%A7%A3%E5%86%B3redis%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%9B%AA%E5%B4%A9/" title="springcache的使用以及解决redis缓存击穿、穿透、雪崩">springcache的使用以及解决redis缓存击穿、穿透、雪崩</a><time datetime="2023-12-01T13:23:36.000Z" title="发表于 2023-12-01 21:23:36">2023-12-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/19/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95+%E4%BC%98%E5%8C%96%EF%BC%88Jmeter%EF%BC%89/" title="压力测试+优化（Jmeter）">压力测试+优化（Jmeter）</a><time datetime="2023-07-19T09:51:42.000Z" title="发表于 2023-07-19 17:51:42">2023-07-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/01/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88RabbitMQ%EF%BC%89/" title="消息中间件（RabbitMQ）">消息中间件（RabbitMQ）</a><time datetime="2023-07-01T11:32:51.000Z" title="发表于 2023-07-01 19:32:51">2023-07-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/01/Redis/" title="Redis">Redis</a><time datetime="2023-06-01T13:18:31.000Z" title="发表于 2023-06-01 21:18:31">2023-06-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/bizhi.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By superchen7</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>